param (
    [Parameter(Mandatory)]
    [string] $dll,
    [string] $basename = [System.IO.Path]::GetFileNameWithoutExtension($dll)
)
function Parse-Line {
    param(
        [string] $line
    )
    # leading Space
    $row = $line -replace '^\s+', ''

    # Empty cols
    $row = $row -replace '\s{10}','  ##  '

    $row = $row -split "\s+"

    $result = @{
        ordinal = $row[0]
        hint = $row[1]
        RVA = $row[2]
        name = $row[3]
    }
    return $result
}

function Output-ExportComment {
    $exports = [System.Collections.ArrayList]@()
    $path = 'C:\\Windows\\System32\\' + $basename

    dumpbin /exports C:\Windows\System32\$dll | Foreach {
        $line = $_
        if ($line -match "^\s+\d+\s+[0-9A-F]+\s+(\d+\s+)?[A-Za-z\.\(\)]") {
            $row = Parse-Line $line
            $exports.add('#pragma comment (linker, "/export:'+ $row.name + '=' + $path + '.' + $row.name + '")') | out-null
        }
    }
    return $exports -join "`n"
}

$output = @"
#pragma once
#pragma comment (lib, 'user32.lib')
$(Output-ExportComment)

#include <Windows.h>

BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD fwdReason, LPVOID lpReserved)
{
    switch (fwdReason)
    {
    case DLL_PROCESS_ATTACH:
        MessageBoxA(NULL,'Test','DLL Test',0);
        break;
    case DLL_THREAD_ATTACH:
        break;
    case DLL_THREAD_DETACH:
        break;
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}
"@
$output = $output -replace "`r", ''

Set-Content -Path "./$basename.cpp" -Value $output
