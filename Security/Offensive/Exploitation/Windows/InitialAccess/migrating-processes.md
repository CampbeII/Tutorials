# Migrating Processes
The goal is to migrate to a process that will not terminate
- explorer.exe (always present)
- notepad.exe (hidden)
- svchost (network communication)

### Process
A container created to house a running application. 
- Each process maintains it's own virtual memory space.
- May be possible to interact with other memory spaces with Win32 APIs

### THreads
- A thread executes the compiled assembly code of the application
- A process may have multiple threads to perform simultanious actions
- Each thread has it's own stack

### Channels
Using the `OpenProcess` API we can open a channel from one process to another.
- Modify the memory space `VirtualAlloc` and `WriteProcess` APIs
- Create new execution thread inside remote process using `CreateRemoteThread`


## Security
```sh
HANDLE OpenProcess (
    DWORD dwDesiredAccess,
    BOOL bInheritHandle,
    DWORD dwProcessId
);
```
To call `OpenProcess` our process needs to posses the appropriate security permissions: 

### Security descirptor 
Specifiies the file perimssions of the executable, access rights of the user and group orginiating from the creator of the process.

### Integrity Level
Blocks access from one process to another when one has a higher integrity level. 
- You cannot migrate to a higher integrity level. You can go lower.

## VirtualAllocEX
`VirtualAlloc` will only work in the current process, to work outside we'll use `VirtualAllocEx` which will work in any process we have a valid handle for.

```sh
LPVOID VirtualAllocEX (
    HANDLE hProcess,
    LPVOID lpAddress,
    SIZE_T dwSize,
    DWORD flAllocationType,
    DWORD flProtect
);
```

Copy date into the remote process. 
```sh
BOOL WriteProcessMemory(
    HANDLE hProcess,
    LPVOID lpBaseAddress,
    LPCVOID lpBuffer,
    SIZE_T nSize,
    SIZE_T *lpNumberOfBytesWritten
);
```

To create a remote thread:
```sh
HANDLE CreateRemoteThread(
    HANDLE hProcess,
    LPSECURITY_ATTRIBUTES lpThreadAttributes,
    SIZE_T dwStackSize,
    LPTHREAD_START_ROUTINE lpStartAddress,
    LPVOID lpParameter,
    DWORD dwCreationFlags,
    LPWORD lpThreadId
);
```

