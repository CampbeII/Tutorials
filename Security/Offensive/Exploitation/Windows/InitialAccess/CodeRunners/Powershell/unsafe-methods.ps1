function LookupFunc 
{
	Param (
		[string] $moduleName, 
		[string] $functionName
	)

	$assemembly = ([AppDomain]::CurrentDomain.GetAssemblies() | Where-Object { 
			$_.GlobalAssemblyCache -And $_.Location.Split('\\')[-1].Equals('System.dll') 
		}
	).GetType('Microsoft.Win32.UnsafeNativeMethods')
	$tmp=@()
	$assembly.GetMethods() | ForEach-Object {
			If ($_.Name -eq "GetProcAddress") {
			$tmp+=$_
		}
	}
	return $tmp[0].Invoke($null, @(($assembly.GetMethod('GetModuleHandle')).Invoke($null, @($moduleName)), $functionName))
}

function GetDelegateType {
    param(
        [Parameter(Position = 0, Mandatory=$true)] [Type[]] $func,
        [Parameter(Position = 1)] [Type] $delType = [Void]
    )
    $MyAssembly = New-Object System.Reflection.AssemblyName('ReflectedDelegate')
    $Domain = [AppDomain]::CurrentDomain
    $MyAssemblyBuilder = $Domain.DefineDynamicAssembly($MyAssembly, [System.Reflection.Emit.AssemblyBuilderAccess]::Run)
    $MyModuleBuilder = $MyAssemblyBuilder.DefineDynamicModule('InMemoryModule', $false)

    $MyTypeBuilder = $MyModuleBuilder.DefineType(
        'MyDelegateType', 
        'Class, 
        Public, 
        Sealed, 
        AnsiClass, 
        AutoClass', 
        [System.MulticastDelegate]
    )
    $MyConstructorBuilder = $MyTypeBuilder.DefineConstructor(
        'RTSpecialName, 
        HideBySig, 
        Public', 
        [System.Reflection.CallingConventions]::Standard, 
        $func
    )
    $MyConstructorBuilder.SetImplementationFlags('Runtime, Managed')
    $MyMethodBuilder = $MyTypeBuilder.DefineMethod(
        'Invoke', 
        'Public, 
        HideBySig, 
        NewSlot, 
        Virtual', 
        $delType, 
        $func
    )
    $MyMethodBuilder.SetImplementationFlags('Runtime, Managed')
    return $MyTypeBuilder.CreateType()

}

# Test With MessageBoxA
$MessageBoxAAddr = LookupFunc user32.dll MessageBoxA
$MessageBoxADelegateType = GetDelegateType @([IntPtr], [string], [string], [int])
$MessageBoxA = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($MessageBoxAAddr, $MessageBoxADelegateType)
$MessageBoxA.Invoke([IntPtr]::Zero, "Caption", "Hello there!", 0)


