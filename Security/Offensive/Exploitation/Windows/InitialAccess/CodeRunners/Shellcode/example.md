GETDELTA:
    jmp NEXT
PREV:
    pop ebx
    jmp END_GETDELTA
NEXT:
    call PREV
    END_GETDELTA
END_GETDELTA:

; esi -> kernelbase
; ebx -> array of api addresses 

GetAPIs Proc

    local AddressFunctions:dword
    local AddressOfNameOrdinals:dword
    local AddressNames:dword
    local NumberOfNames:dword

GetPEHeader:
    mov edi, esi
    mov eax, [esi].IMAGE_DOS_HEADER.e_elfanew
    add esi, eax

GetExportTable:
    mov eax, [esi].IMAGE_NT_HEADERS.OptionalHeader.DataDirectory[0].VirtualAddress
    add eax, edi
    mov esi, eax

GetArrays:
    mov eax, [esi].IMAGE_EXPORT_DIRECTORY.AddressOfFunctions
    add eax, edi
    mov AddressFunctions, eax

    mov eax, [esi].IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals
    add eax, edi
    mov AddressOfNameOrdinals, eax

    mov eax, [esi].IMAGE_EXPORT_DIRECTORY.AddressOfNames
    add eax, edi
    mov AddressNames, eax

    mov eax, [esi].IMAGE_EXPORT_DIRECTORY.NumberOfNames
    mov NumberOfNames, eax
    push esi
    mov esi, AddressNames
    xor ecx, ecx

GetAPIs:
    lodsd
    push esi
    lea esi, [eax + edi]
    xor edx, edx
    xor eax, eax
    
ChecksumCalc:
    lodsd
    test eax, eax
    jz CheckFunction
    add edx, eax
    xor edx, eax
    inc edx
    jmp ChecksumCalc

CheckFunction:
    pop esi
    xor eax, eax
    cmp edx 0AAAAAAAAh
    jz FoundAddress

    cmp edx 0BBBBBBBBh
    inc eax
    jz FoundAddress

    cmp edx 0CCCCCCCCh
    inc eax
    jz FoundAddress

    xor eax, eax
    inc ecx
    cmp ecx, NumberOfNames
    jz EndFunc
    jmp GetAPIs

FoundAddress:
    mov edx, esi
    pop esi
    push eax
    mov eax, AddressOfNameOrdinals
    movzx ecx, word ptr [eax + ecx * 2]
    mov eax, AddressFunctions
    movzx ecx, dword ptr [eax + ecx * 4]
    add eax, edi
    pop ecx
    mov [ebx + ecx * 4], eax
    push esi
    mov esi, edx
    jmp GetAPIs
EndFunc:
    Mov esi, edi
    ret
    GetAPIs EndP
